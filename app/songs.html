<!DOCTYPE html>

<html>
<head>

<link rel="stylesheet" href="../vendor/bootstrap3.3.4/css/bootstrap.min.css">
<link rel="stylesheet" href="css/index.css">
<link rel="stylesheet" href="css/songs.css">
<link href='http://fonts.googleapis.com/css?family=IM+Fell+DW+Pica' rel='stylesheet' type='text/css'>

<script src="../vendor/jquery/jquery-1.11.2.min.js"></script>
<script src="../vendor/bootstrap3.3.4/js/bootstrap.min.js"></script>
<script src="../vendor/typeahead.js"></script>
<script src="../vendor/fuse.js"></script>
<script src="../vendor/handlebars-v3.0.3.js"></script>

<script id="search-result-template" type="text/x-handlebars-template">
  <a href='karaoke.html' class='list-group-item'>
    <img src='images/person.gif' style='height: 20px; width: 20px;'></img>
    {{title}} - {{artist}}
    <div style='float:right'>{{length}}</div>
  </a>
</script>

<script>
$(function(){
  $("#search-text").keypress(function(e){
    if(e.keyCode == 13){
      search($('#search-text').val());
      $('.typeahead').typeahead('close');
    }
  });

  $('.typeahead').bind('typeahead:select', function(ev, suggestion) {
    search($('#search-text').val());
  });    

  $('#search-icon').click(function(){
    search($('#search-text').val());
  });


  var substringMatcher = function(strs) {
    return function findMatches(q, cb) {
      if(q==''){
        return cb(['What is Love', 'Uptown Funk', 'Take Me To Church']);
      }

      var matches, substringRegex;
   
      // an array that will be populated with substring matches
      matches = [];
   
      // regex used to determine if a string contains the substring `q`
      substrRegex = new RegExp(q, 'i');
   
      // iterate through the pool of strings and for any string that
      // contains the substring `q`, add it to the `matches` array
      $.each(strs, function(i, str) {
        if (substrRegex.test(str)) {
          matches.push(str);
        }
      });
   
      cb(matches);
    };
  };
   
  Songs = [];

  // Source: http://stackoverflow.com/questions/10191941/jquery-unique-on-an-array-of-strings
  uniq = function(array){
      return array.filter(function(el, index, arr) {
          return index === arr.indexOf(el);
      });
  }

  $.get('text/songs.txt', function(data) {
    songs = data.split('\n');
    titles = [];
    artists = [];

    for(i = 0; i<songs.length; i++){
      var title = songs[i].split(' - ')[0];
      var artist = songs[i].split(' - ')[1];

      Songs.push({id: i, title: title, artist: artist});
      titles.push(title);
      artists.push(artist);
    }

    autocomplete_data = titles.concat(uniq(artists));
    setup_typeahead();
  });

  setup_typeahead = function(){
     
    $('#search-text').typeahead({
      hint: true,
      highlight: true,
      minLength: 0
    },
    {
      name: 'songs',
      source: substringMatcher(autocomplete_data)
    });

  };

  var options = {
    keys: ['artist', 'title'],   // keys to search in
    maxPatternLength: 200
  }

  f = new Fuse(Songs, options);

  var source   = $("#search-result-template").html();
  var template = Handlebars.compile(source);

  search = function(query){
    results = f.search(query);
    console.log('found');

    $('#search-results').html('');

    for(i = 0; i<results.length; i++){
      var mins = Math.floor((Math.random() * 6) + 2);
      var secs = Math.floor((Math.random() * 49) + 11);
      var length = mins + ":" + secs;

      var context = {title: results[i].title, artist: results[i].artist, length: length};
      var html    = template(context);

      $('#search-results').append(html);
    }

    $('#search-results').show();
  };

});
</script>

</head>

<body>

<nav id="navigation" class="navbar navbar-default">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Singing Simply</a>
    </div>

    <ul class="nav navbar-nav">
      <li><a href="start.html">Getting started</a></li>
      <li><a href="exercises.html">Exercises</a></li>
      <li class='active'><a href="songs.html">Songs</a></li>
      <li><a href="progress.html">My Progress</a></li>
    </ul>

    <ul class="nav navbar-nav navbar-right">
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Joe Schmoe <span class="caret"></span></a>
        <ul class="dropdown-menu" role="menu">
          <li><a href="#">Sign out</a></li>
        </ul>
      </li>
    </ul>
    </div><!-- /.navbar-collapse -->
  </div>
</nav>

<div class="container songs-container">  
  <div class="row">
    <div class='col-xs-12'>
      <h1 class="text-center">Select a song</h1>
      <div class="input-group" style="padding-left: 20px; padding-right: 20px;">
        <form id='search-form' style='position: relative;'>
          <input id='search-text' type="text" class="typeahead form-control" placeholder="Name of the songs, singers, bands...">
          <span id='search-icon' class="glyphicon glyphicon-search" aria-hidden="true"></span>
        </form>
      </div><!-- /input-group -->
      <div id='search-results' class='list-group'>
      </div>
    </div>
  </div>
</div>

</body>

</html>
